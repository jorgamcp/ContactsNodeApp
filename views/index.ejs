<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contacts app with templates</title>
    <link rel="stylesheet" href="/assets/style.css" />
 
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">



  </head>
  <body>
    <div class="my-container">
        
      <nav>
        <h3>Contacts App with templates ejs!</h3>
      </nav>
      <div class="app-container">
        <!-- Button trigger modal -->


<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Add Contact</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%- include('add.ejs') -%>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" id="mibotoncabron" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

        <div id="buttons">
          <a class="btn btn-primary m-3" id="btn-addContact" href="/add">AÃ±adir Contacto</a></button>
          <button type="button" class="btn btn-primary m-3" data-bs-toggle="modal" data-bs-target="#exampleModal">
            Launch demo modal
          </button>
        </div>
        <table id="mycontacttable">
          <thead>
            <th>Contact Id</th>
            <th>Nombre</th>
            <th>Edad</th>
            <th colspan="2">Acciones</th>
          </thead>
          <tbody>
            <% for(var i = 0; i < data.length;i++){ %>
            <tr>
              <td><%= data[i].contact_id %></td>
              <td><%= data[i].name %></td>
              <td><%= data[i].age %></td>
              <td>
                <a href="/edit/<%= data[i].contact_id %>"> Editar</a>
              </td>
              <td>
                <a href="/delete/<%= data[i].contact_id %>"> Eliminar</a>
              </td>
            </tr>
            <% } %>
          </tbody>
        </table>
      
      </div>
    </div>
  </body>
  <!-- Option 1: Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
 
  <script src="/assets/js/main.js"></script>
  <script>

       
      var boton = document.querySelectorAll('#mibotoncabron');
      const container = document.getElementById('exampleModal');
      const modal = new bootstrap.Modal(container);
          
      boton[0].addEventListener('click', async function(e){
           e.preventDefault();
           console.log('quieres enviar el form del modal!');

           let nombre = document.querySelector('#nombreFormField').value;
           let edad = document.querySelector('#edadFormField').value;

          console.log('nombre ' + nombre);
          console.log('edad' + edad);

           

            const rawResponse = await fetch('/contacts',{
            method:'POST',
            headers:{
              'Accept':'application/json',
              'Content-Type':'application/json'
            },
            body: JSON.stringify({ name: nombre,age:edad})
          });
          const content = await rawResponse.json();
           
         
          modal.hide();
          console.log(content);
           await repaintHTMLTable({contact_id: content.insertedId,name:nombre,age:edad});
          });
     

         async function repaintHTMLTable(json){
            console.log('json var'+ JSON.stringify(json));
            var tbodyRef = document.getElementById('mycontacttable').getElementsByTagName('tbody')[0];

              // Insert a row at the end of table
              var newRow = tbodyRef.insertRow();

              // Insert a cell at the end of the row
              var contactid = newRow.insertCell();
              var contactName = newRow.insertCell();
              var contactAge = newRow.insertCell();
              var edit = newRow.insertCell();
              var del = newRow.insertCell();
 
              // Append a text node to the cell
              var textContactId = document.createTextNode(json.contact_id);
              var textContactName = document.createTextNode(json.name);
              var textContactAge = document.createTextNode(json.age);

              var textEdit = document.createTextNode('Editar');
              var textDel = document.createTextNode('Eliminar');
              var aEditar = document.createElement('a');
              var aEliminar = document.createElement('a');

              aEditar.appendChild(textEdit);
              aEliminar.appendChild(textDel);

              aEditar.title="Editar";
              aEliminar.title="Eliminar";
              aEditar.href=`/edit/${json.contact_id}`; // http://localhost:3000/edit/41
              aEliminar.href=`/delete/${json.contact_id}`;

              contactid.appendChild(textContactId);
              contactName.appendChild(textContactName);
              contactAge.appendChild(textContactAge);



              edit.appendChild(aEditar);
              del.appendChild(aEliminar);

            

                
          }

  </script>
</html>
